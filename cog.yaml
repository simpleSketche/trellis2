# Configuration for Cog - https://github.com/replicate/cog
build:
  gpu: true
  cuda: "11.8"
  python_version: "3.10"

  system_packages:
    - "git"
    - "wget"
    - "ninja-build"
    - "build-essential"
    - "cmake"
    - "pkg-config"
    - "gcc-11"
    - "g++-11"
    - "libjpeg-dev"
    - "libgl1-mesa-glx"
    - "libglib2.0-0"
    - "libegl1"
    - "libgles2"

  python_packages:
    # Force CUDA-enabled PyTorch wheels for CUDA 11.8
    - "--extra-index-url https://download.pytorch.org/whl/cu118"
    - "torch==2.5.1+cu118"
    - "torchvision==0.20.1+cu118"

    - "imageio==2.36.0"
    - "imageio-ffmpeg==0.5.1"
    - "tqdm==4.67.1"
    - "easydict==1.13"
    - "opencv-python-headless==4.10.0.84"
    - "ninja==1.13.0"
    - "trimesh==4.5.3"
    - "transformers==4.48.0"
    - "tensorboard==2.18.0"
    - "pandas==2.2.3"
    - "lpips==0.1.4"
    - "zstandard==0.25.0"
    - "pillow==11.0.0"
    - "kornia==0.8.0"
    - "timm==1.0.12"
    - "einops==0.8.0"
    - "psutil==6.1.0"
    - "plyfile==1.1.2"
    - "moderngl==5.12.0"
    - "scipy==1.14.1"
    - "huggingface_hub>=0.20.0"

  run:
    # Use compiler versions that are typically friendlier with CUDA extension builds
    - "update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 110"
    - "update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 110"
    - "update-alternatives --set gcc /usr/bin/gcc-11"
    - "update-alternatives --set g++ /usr/bin/g++-11"

    # Limit parallel builds to avoid CI OOM
    - "export MAKEFLAGS='-j2'"
    - "export CMAKE_BUILD_PARALLEL_LEVEL=2"
    - "export NINJAFLAGS='-j2'"
    - "export MAX_JOBS=2"

    - "pip install --upgrade pip setuptools wheel"

    # Workspace for building extensions
    - "mkdir -p /tmp/extensions"

    # Install utils3d
    - "pip install git+https://github.com/EasternJournalist/utils3d.git@9a4eb15e4021b67b12c460c7057d642626897ec8"

    # Install flash-attn
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install flash-attn==2.7.3 --no-build-isolation"

    # Install nvdiffrast
    - "git clone -b v0.4.0 https://github.com/NVlabs/nvdiffrast.git /tmp/extensions/nvdiffrast"
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install /tmp/extensions/nvdiffrast --no-build-isolation"

    # Install nvdiffrec
    - "git clone -b renderutils https://github.com/JeffreyXiang/nvdiffrec.git /tmp/extensions/nvdiffrec"
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install /tmp/extensions/nvdiffrec --no-build-isolation"

    # Install CuMesh
    - "git clone https://github.com/JeffreyXiang/CuMesh.git /tmp/extensions/CuMesh --recursive"
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install /tmp/extensions/CuMesh --no-build-isolation"

    # Install FlexGEMM
    - "git clone https://github.com/JeffreyXiang/FlexGEMM.git /tmp/extensions/FlexGEMM --recursive"
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install /tmp/extensions/FlexGEMM --no-build-isolation"

    # Install o-voxel (copy from project and install eigen)
    - "cp -r o-voxel /tmp/extensions/o-voxel"
    - "git clone --depth 1 https://gitlab.com/libeigen/eigen.git /tmp/extensions/o-voxel/third_party/eigen"
    - "TORCH_CUDA_ARCH_LIST='8.0;8.6;8.9;9.0' pip install /tmp/extensions/o-voxel --no-build-isolation"

    # Clean up build dir
    - "rm -rf /tmp/extensions"

    # ============================================
    # PRE-DOWNLOAD MODELS
    # ============================================
    # Note: authenticate by providing HF_TOKEN / HUGGINGFACE_HUB_TOKEN at build time
    - "python -c \"from huggingface_hub import snapshot_download; snapshot_download('microsoft/TRELLIS.2-4B', local_dir='/src/models/TRELLIS.2-4B')\""
    - "python -c \"from huggingface_hub import snapshot_download; snapshot_download('facebook/dinov3-vitl16-pretrain-lvd1689m', local_dir='/src/models/dinov3')\""
    - "python -c \"from huggingface_hub import snapshot_download; snapshot_download('briaai/RMBG-2.0', local_dir='/src/models/rmbg')\""

predict: "predict.py:Predictor"
